<div class="cementerio-container">
  <!-- Contenedor de notificaciones -->
  <app-notification-container></app-notification-container>
  
  <div class="header-section">
    <div class="title-wrapper">
      <div class="title-row">
        <h1>
          <i class="fas fa-skull-crossbones"></i> 
          Cementerio de Equipos y Dispositivos
          <span class="subtitle">Equipos y dispositivos dados de baja</span>
        </h1>
        
        <!-- Bot√≥n de imprimir/exportar PDF -->
        <button 
          class="btn btn-primary btn-sm print-btn" 
          (click)="exportarPDF()"
          title="Exportar lista filtrada a PDF"
          [disabled]="loading || equiposFiltrados.length === 0">
          <i class="fas fa-file-pdf"></i>
          Imprimir
        </button>
      </div>
    </div>
    
    <!-- Filtros por tipo -->
    <div class="filters-container" *ngIf="!loading">
      <button 
        class="filter-btn" 
        [class.active]="filtroTipo === 'todos'"
        (click)="filtrarPorTipo('todos')"
        [style.--device-color]="'#2c3e50'"
        [style.--device-bg-color]="'#f8f9fa'"
        [style.--device-border-color]="'#dee2e6'">
        <i class="fas fa-th-large"></i>
        <span>Todos</span>
        <span class="count">({{ getTotalItems() }})</span>
      </button>
      
      <button 
        class="filter-btn" 
        [class.active]="filtroTipo === 'equipos'"
        [style.--device-color]="'#1976d2'"
        [style.--device-bg-color]="'#e3f2fd'"
        [style.--device-border-color]="'#bbdefb'"
        (click)="filtrarPorTipo('equipos')">
        <i class="fas fa-desktop"></i>
        <span>Equipos</span>
        <span class="count">({{ getTotalEquipos() }})</span>
      </button>
      
      <button 
        class="filter-btn" 
        [class.active]="filtroTipo === 'dispositivos'"
        [style.--device-color]="'#d32f2f'"
        [style.--device-bg-color]="'#ffebee'"
        [style.--device-border-color]="'#ffcdd2'"
        (click)="filtrarPorTipo('dispositivos')">
        <i class="fas fa-network-wired"></i>
        <span>Dispositivos</span>
        <span class="count">({{ getTotalDispositivos() }})</span>
      </button>
    </div>
  </div>

  <div class="cementerio-content">
    <!-- Filtro de b√∫squeda -->
    <div class="row mb-3">
      <div class="col-12">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por nombre de equipo..." 
          [formControl]="nombreEquipoControl" 
          style="max-width: 320px;"
          data-help="üîç Busca equipos espec√≠ficos en el cementerio">
      </div>
    </div>

    <!-- Indicador de carga -->
    <div *ngIf="loading" class="text-center my-4">
      <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando equipos del cementerio...</p>
    </div>

    <!-- Mensaje cuando no hay equipos -->
    <div *ngIf="!loading && equiposFiltrados.length === 0" class="empty-state">
      <i class="fas fa-smile"></i>
      <h3>¬°No hay equipos en el cementerio!</h3>
      <p>Todos los equipos est√°n activos o en almac√©n.</p>
    </div>

    <!-- Tabla de equipos en baja -->
    <div class="table-container" *ngIf="!loading && equiposFiltrados.length > 0">
      <table class="cementerio-table">
        <thead>
          <tr>
            <th>
              <div class="th-content">
                <span>Tipo</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Nombre</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Detalles</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Fecha de Baja</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Usuario</span>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Observaciones</span>
              </div>
            </th>
            <th *ngIf="canManageAssets()">
              <div class="th-content">
                <span>Acciones</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of pagedEquipos" class="item-row" [ngClass]="{'equipo-row': item.tipo === 'EQUIPO', 'dispositivo-row': item.tipo === 'DISPOSITIVO'}" (click)="verDetallesItem(item)" data-help="üëÅÔ∏è Haz clic para ver los detalles">
            <td>
              <div class="tipo-badge" [ngClass]="item.tipo === 'EQUIPO' ? 'equipo' : 'dispositivo'">
                <i class="fas" [ngClass]="item.tipo === 'EQUIPO' ? 'fa-desktop' : 'fa-network-wired'"></i>
                {{ item.tipo === 'EQUIPO' ? 'Equipo' : 'Dispositivo' }}
              </div>
            </td>
            <td>
              <div class="item-name">
                <i class="fas equipment-icon" [ngClass]="getItemIcon(item)"></i>
                <div class="item-info">
                  <span class="name">{{ item.name || item.mac }}</span>
                  <small class="ip" *ngIf="item.ipAddr || item.ip">{{ item.ipAddr || item.ip }}</small>
                </div>
              </div>
            </td>
            <td>
              <div class="item-details">
                <!-- Para equipos -->
                <div *ngIf="item.tipo === 'EQUIPO'">
                  <span class="type-badge" [ngClass]="getTypeBadgeClass(item.biosType)">
                    {{ item.biosType || 'Desconocido' }}
                  </span>
                  <div class="os-badge" [ngClass]="{'windows': item.osName?.includes('Windows'), 'linux': item.osName?.includes('Linux')}">
                    <i class="fab" [ngClass]="{'fa-windows': item.osName?.includes('Windows'), 'fa-linux': item.osName?.includes('Linux')}"></i>
                    {{ item.osName || 'Desconocido' }}
                  </div>
                </div>
                <!-- Para dispositivos -->
                <div *ngIf="item.tipo === 'DISPOSITIVO'">
                  <span class="type-badge dispositivo" [style.background-color]="getDeviceTypeConfig(item.type).backgroundColor" [style.color]="getDeviceTypeConfig(item.type).color">
                    {{ item.type || 'Desconocido' }}
                  </span>
                  <small class="description">{{ item.description || 'Sin descripci√≥n' }}</small>
                </div>
              </div>
            </td>
            <td>
              <div class="fecha-baja">
                <i class="fas fa-calendar-times"></i>
                <span>{{ formatFecha(item.fechaBaja) }}</span>
              </div>
            </td>
            <td>
              <span class="usuario-cambio">{{ item.usuarioCambio || 'No especificado' }}</span>
            </td>
            <td>
              <div class="observaciones-cell" *ngIf="!estaEditandoObservaciones(item)" 
                   (click)="iniciarEdicionObservaciones(item, $event)"
                   [class.editable]="canManageAssets()"
                   [title]="canManageAssets() ? 'Haz clic para editar' : item.observaciones">
                <span class="observaciones-text">{{ item.observaciones || 'Sin observaciones' }}</span>
                <i class="fas fa-edit edit-icon" *ngIf="canManageAssets()"></i>
              </div>
              <div class="observaciones-edit" *ngIf="estaEditandoObservaciones(item)" 
                   (click)="$event.stopPropagation()">
                <textarea 
                  [(ngModel)]="editingObservacionesValue"
                  class="form-control observaciones-textarea"
                  rows="2"
                  maxlength="500"
                  placeholder="Ingrese observaciones..."></textarea>
                <div class="observaciones-actions">
                  <button class="btn btn-sm btn-success" 
                          (click)="guardarObservaciones(item, $event)"
                          [disabled]="updatingObservaciones">
                    <i class="fas" [ngClass]="updatingObservaciones ? 'fa-spinner fa-spin' : 'fa-check'"></i>
                  </button>
                  <button class="btn btn-sm btn-secondary" 
                          (click)="cancelarEdicionObservaciones($event)"
                          [disabled]="updatingObservaciones">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </td>
            <td *ngIf="canManageAssets()">
              <div class="action-buttons">
                <button 
                  *ngIf="item.tipo === 'EQUIPO'"
                  class="btn btn-primary btn-sm transferir-btn" 
                  (click)="transferirEquipo(item); $event.stopPropagation()"
                  [disabled]="transferiendoItemId === item.id"
                  title="Transferir este equipo a otro almac√©n"
                  data-help="üîÑ Permite transferir el equipo a cualquier almac√©n (laboratorio o almac√©n regular)">
                  <i class="fas" [ngClass]="transferiendoItemId === item.id ? 'fa-spinner fa-spin' : 'fa-exchange-alt'"></i>
                  {{ transferiendoItemId === item.id ? 'Transferiendo...' : 'Transferir' }}
                </button>
                <button 
                  class="btn btn-success btn-sm reactivar-btn" 
                  (click)="reactivarItem(item); $event.stopPropagation()"
                  [disabled]="reactivatingItemId === (item.id || item.mac)"
                  [title]="'Reactivar ' + (item.tipo === 'EQUIPO' ? 'equipo' : 'dispositivo')"
                  [attr.data-help]="'üîÑ Reactivar ' + (item.tipo === 'EQUIPO' ? 'equipo' : 'dispositivo') + ' y devolverlo a la lista activa'">
                  <i class="fas" [ngClass]="reactivatingItemId === (item.id || item.mac) ? 'fa-spinner fa-spin' : 'fa-undo'"></i>
                  {{ reactivatingItemId === (item.id || item.mac) ? 'Reactivando...' : 'Reactivar' }}
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagination-container" *ngIf="!loading && equiposFiltrados.length > 0">
      <ngb-pagination
        [(page)]="page"
        [pageSize]="pageSize"
        [collectionSize]="collectionSize"
        [boundaryLinks]="true"
        [maxSize]="5"
        [rotate]="true"
        [ellipses]="false"
        class="custom-pagination">
      </ngb-pagination>
    </div>
  </div>
</div>

<!-- Modal de reactivaci√≥n -->
<div *ngIf="showReactivarDialog" class="confirm-dialog-overlay">
  <div class="confirm-dialog reactivar-dialog">
    <div class="confirm-dialog-title">
      <i class="fas fa-undo"></i>
      Reactivar {{ itemToReactivar?.tipo === 'EQUIPO' ? 'Equipo' : 'Dispositivo' }}
    </div>
    <div class="confirm-dialog-message">
      <p>¬øEst√° seguro que desea reactivar el {{ itemToReactivar?.tipo === 'EQUIPO' ? 'equipo' : 'dispositivo' }} <strong>{{ itemToReactivar?.name || itemToReactivar?.mac }}</strong>?</p>
      <p class="text-muted">El {{ itemToReactivar?.tipo === 'EQUIPO' ? 'equipo' : 'dispositivo' }} volver√° a aparecer en la lista de activos y se eliminar√° del cementerio.</p>
    </div>
    <div class="confirm-dialog-buttons">
      <button class="confirm-dialog-button cancel" (click)="cancelarReactivacion()">
        Cancelar
      </button>
      <button 
        class="confirm-dialog-button confirm reactivar" 
        (click)="confirmarReactivacion()"
        [disabled]="reactivatingItemId === (itemToReactivar?.id || itemToReactivar?.mac)">
        <i class="fas" [ngClass]="reactivatingItemId === (itemToReactivar?.id || itemToReactivar?.mac) ? 'fa-spinner fa-spin' : 'fa-undo'"></i>
        {{ reactivatingItemId === (itemToReactivar?.id || itemToReactivar?.mac) ? 'Reactivando...' : 'Reactivar' }}
      </button>
    </div>
  </div>
</div> 