<div class="assets-container">
  <!-- Contenedor de notificaciones -->
  <app-notification-container></app-notification-container>
  
  <div class="header-section">
    <div class="title-wrapper">
      <h1>
        <i class="fas fa-laptop-code"></i> 
        Inventario de Terminales
        <span *ngIf="route.snapshot.queryParams['softwareName']" class="filter-indicator">
          - Filtrado por software: {{ route.snapshot.queryParams['softwareName'] }}
        </span>
      </h1>
      
      <!-- Filtros por tipo de activo -->
      <div class="filters-container">
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === ''"
          (click)="filterByType('')"
          data-help="🎯 Filtro para mostrar todos los activos sin restricciones">
          <i class="fas fa-th-large"></i>
          <span>Todos</span>
          <span class="count">({{totalAssets}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'DESKTOP'"
          [style.--device-color]="'#2e7d32'"
          [style.--device-bg-color]="'#e8f5e9'"
          [style.--device-border-color]="'#c8e6c9'"
          (click)="filterByType('DESKTOP')">
          <i class="fas fa-desktop" style="color: #2e7d32;"></i>
          <span>Desktops</span>
          <span class="count">({{pcCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'MINI PC'"
          [style.--device-color]="'#f57c00'"
          [style.--device-bg-color]="'#fff3e0'"
          [style.--device-border-color]="'#ffe0b2'"
          (click)="filterByType('MINI PC')">
          <i class="fas fa-laptop" style="color: #f57c00;"></i>
          <span>Mini PCs</span>
          <span class="count">({{miniPcCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'LAPTOP'"
          [style.--device-color]="'#1976d2'"
          [style.--device-bg-color]="'#e3f2fd'"
          [style.--device-border-color]="'#bbdefb'"
          (click)="filterByType('LAPTOP')">
          <i class="fas fa-laptop" style="color: #1976d2;"></i>
          <span>Laptops</span>
          <span class="count">({{laptopCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'TOWER'"
          [style.--device-color]="'#34495e'"
          [style.--device-bg-color]="'#ecf0f1'"
          [style.--device-border-color]="'#bdc3c7'"
          (click)="filterByType('TOWER')">
          <i class="fas fa-server" style="color: #34495e;"></i>
          <span>Towers</span>
          <span class="count">({{towerCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'LOW PROFILE DESKTOP'"
          [style.--device-color]="'#8e44ad'"
          [style.--device-bg-color]="'#f4e6f7'"
          [style.--device-border-color]="'#e8d5f0'"
          (click)="filterByType('LOW PROFILE DESKTOP')">
          <i class="fas fa-desktop" style="color: #8e44ad;"></i>
          <span>Low Profile</span>
          <span class="count">({{lowProfileCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'MINI TOWER'"
          [style.--device-color]="'#e67e22'"
          [style.--device-bg-color]="'#fdf2e9'"
          [style.--device-border-color]="'#fad7b0'"
          (click)="filterByType('MINI TOWER')">
          <i class="fas fa-server" style="color: #e67e22;"></i>
          <span>Mini Tower</span>
          <span class="count">({{miniTowerCount}})</span>
        </button>
        
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'DESCONOCIDO'"
          [style.--device-color]="'#95a5a6'"
          [style.--device-bg-color]="'#f8f9fa'"
          [style.--device-border-color]="'#dee2e6'"
          (click)="filterByType('DESCONOCIDO')">
          <i class="fas fa-question-circle" style="color: #95a5a6;"></i>
          <span>Desconocido</span>
          <span class="count">({{desconocidoCount}})</span>
        </button>
      </div>
    </div>
  </div>

  <div class="assets-content">
    <!-- Filtro de búsqueda arriba de la tabla -->
    <div class="row mb-3">
      <div class="col-12">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por nombre de equipo..." 
          [formControl]="nombreEquipoControl" 
          style="max-width: 320px;"
          data-help="🔍 Busca equipos específicos escribiendo parte del nombre del equipo">
      </div>
    </div>

    <!-- Indicador de carga -->
    <div *ngIf="loading" class="text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando datos...</p>
    </div>

    <div class="table-container" *ngIf="!loading">
      <table class="assets-table">
        <thead>
          <tr>
            <th (click)="sortData('name')" [class.active]="sortColumn === 'name'" data-help="📊 Haz clic para ordenar la lista por nombre de equipo">
              <div class="th-content">
                <span>Equipo</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'name' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'name' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'name'
                }"></i>
              </div>
            </th>
            <th (click)="sortData('osName')" [class.active]="sortColumn === 'osName'">
              <div class="th-content">
                <span>Sistema Operativo</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'osName' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'osName' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'osName'
                }"></i>
              </div>
            </th>
            <th (click)="sortData('ipAddr')" [class.active]="sortColumn === 'ipAddr'">
              <div class="th-content">
                <span>IP</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'ipAddr' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'ipAddr' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'ipAddr'
                }"></i>
              </div>
            </th>
            <th (click)="sortData('biosType')" [class.active]="sortColumn === 'biosType'">
              <div class="th-content">
                <span>Tipo</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'biosType' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'biosType' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'biosType'
                }"></i>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Nro. Compra</span>
              </div>
            </th>
            <th *ngIf="canManageAssets()">
              <div class="th-content">
                <span>Acciones</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let asset of pagedAssets" (click)="verDetallesAsset(asset)" class="asset-row" data-help="👁️ Haz clic para ver los detalles completos de este equipo">
            <td>
              <div class="asset-name">
                <i class="fas" [ngClass]="{
                  'fa-desktop': asset.biosType === 'DESKTOP' || asset.biosType === 'LOW PROFILE DESKTOP',
                  'fa-laptop': asset.biosType === 'LAPTOP' || asset.biosType === 'NOTEBOOK',
                  'fa-tablet-alt': asset.biosType === 'MINI PC',
                  'fa-server': asset.biosType === 'TOWER' || asset.biosType === 'MINI TOWER',
                  'fa-question-circle': asset.biosType === 'DESCONOCIDO' || !asset.biosType
                }"></i>
                <span>{{ asset.name }}</span>
              </div>
            </td>
            <td>
              <div class="os-badge" [ngClass]="{'windows': asset.osName?.includes('Windows'), 'linux': asset.osName?.includes('Linux')}">
                <i class="fab" [ngClass]="{'fa-windows': asset.osName?.includes('Windows'), 'fa-linux': asset.osName?.includes('Linux')}"></i>
                {{ asset.osName || 'Desconocido' }}
              </div>
            </td>
            <td>
              <span class="ip-address">{{ asset.ipAddr || 'No asignada' }}</span>
            </td>
            <td>
              <span class="type-badge" [ngClass]="{
                'desktop': asset.biosType === 'DESKTOP',
                'laptop': asset.biosType === 'LAPTOP' || asset.biosType === 'NOTEBOOK',
                'mini': asset.biosType === 'MINI PC',
                'tower': asset.biosType === 'TOWER',
                'low-profile': asset.biosType === 'LOW PROFILE DESKTOP',
                'mini-tower': asset.biosType === 'MINI TOWER',
                'desconocido': asset.biosType === 'DESCONOCIDO' || !asset.biosType
              }">
                {{ asset.biosType || 'Desconocido' }}
              </span>
            </td>
            <td>
              <span class="compra-link" (click)="verDetallesActivo(asset.name); $event.stopPropagation()">
                {{getNumeroCompra(asset.name)}}
              </span>
            </td>
            <td *ngIf="canManageAssets()">
              <div class="action-buttons">
                <!-- Botones de cambio de estado solo si hay permisos -->
                <ng-container *ngIf="canManageAssetStates()">
                  <button 
                    class="btn btn-warning btn-sm estado-btn baja-btn" 
                    (click)="darDeBaja(asset); $event.stopPropagation()"
                    [disabled]="changingStateAssetId === asset.id"
                    title="Dar de baja este equipo (enviar al cementerio)"
                    data-help="⚰️ Marca este equipo como dado de baja y lo envía al cementerio">
                    <i class="fas" [ngClass]="changingStateAssetId === asset.id ? 'fa-spinner fa-spin' : 'fa-times-circle'"></i>
                    Baja
                  </button>
                  <!-- Botón de almacén temporalmente comentado
                  <button 
                    class="btn btn-info btn-sm estado-btn almacen-btn" 
                    (click)="enviarAAlmacen(asset); $event.stopPropagation()"
                    [disabled]="changingStateAssetId === asset.id"
                    title="Enviar este equipo al almacén"
                    data-help="📦 Marca este equipo como almacenado">
                    <i class="fas" [ngClass]="changingStateAssetId === asset.id ? 'fa-spinner fa-spin' : 'fa-archive'"></i>
                    Almacén
                  </button>
                  -->
                </ng-container>
                
                <!-- Mensaje informativo si no hay permisos para cambio de estado -->
                <small *ngIf="!canManageAssetStates()" class="text-muted">
                  Requiere permisos de GM o Administrador
                </small>
                
                <!-- Botón de eliminar (siempre disponible si puede gestionar assets) -->
                <button 
                  class="btn btn-danger btn-sm delete-btn" 
                  (click)="eliminarAsset(asset); $event.stopPropagation()"
                  [disabled]="deletingAssetId === asset.id"
                  title="Eliminar este equipo y todos sus datos relacionados"
                  data-help="🗑️ Elimina permanentemente este equipo y todos sus datos relacionados de la base de datos">
                  <i class="fas" [ngClass]="deletingAssetId === asset.id ? 'fa-spinner fa-spin' : 'fa-trash'"></i>
                  {{ deletingAssetId === asset.id ? 'Eliminando...' : 'Eliminar' }}
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-container" *ngIf="!loading">
      <ngb-pagination
        [(page)]="page"
        [pageSize]="pageSize"
        [collectionSize]="collectionSize"
        [boundaryLinks]="true"
        [maxSize]="5"
        [rotate]="true"
        [ellipses]="false"
        class="custom-pagination">
      </ngb-pagination>
    </div>
  </div>
</div>

<!-- Diálogo de confirmación -->
<div *ngIf="showConfirmDialog" class="confirm-dialog-overlay">
  <div class="confirm-dialog">
    <div class="confirm-dialog-title">
      <i class="fas fa-exclamation-triangle"></i>
      Confirmar Eliminación
    </div>
    <div class="confirm-dialog-message">
      ¿Está seguro que desea eliminar este equipo? Esta acción no se puede deshacer.
    </div>
    <div class="confirm-dialog-buttons">
      <button class="confirm-dialog-button cancel" (click)="cancelarEliminacion()">
        Cancelar
      </button>
      <button class="confirm-dialog-button confirm" (click)="confirmarEliminacion()">
        Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Diálogo de cambio de estado -->
<div *ngIf="showEstadoDialog" class="confirm-dialog-overlay">
  <div class="confirm-dialog estado-dialog">
    <div class="confirm-dialog-title">
      <i class="fas" [ngClass]="estadoAction === 'baja' ? 'fa-times-circle' : 'fa-archive'"></i>
      {{ estadoAction === 'baja' ? 'Dar de Baja' : 'Enviar a Almacén' }}
    </div>
    <div class="confirm-dialog-message">
      <p>¿Está seguro que desea {{ getEstadoActionText() }} el equipo <strong>{{ assetToChangeState?.name }}</strong>?</p>
      <div class="observaciones-container">
        <label for="observaciones">Observaciones (opcional):</label>
        <textarea 
          id="observaciones"
          [(ngModel)]="estadoObservaciones" 
          placeholder="Ingrese observaciones sobre el cambio de estado..."
          maxlength="500"
          rows="3"></textarea>
        <small class="text-muted">{{ estadoObservaciones.length }}/500 caracteres</small>
      </div>
    </div>
    <div class="confirm-dialog-buttons">
      <button class="confirm-dialog-button cancel" (click)="cancelarCambioEstado()">
        Cancelar
      </button>
      <button 
        class="confirm-dialog-button confirm" 
        [ngClass]="estadoAction === 'baja' ? 'baja' : 'almacen'"
        (click)="confirmarCambioEstado()"
        [disabled]="changingStateAssetId === assetToChangeState?.id">
        <i class="fas" [ngClass]="changingStateAssetId === assetToChangeState?.id ? 'fa-spinner fa-spin' : (estadoAction === 'baja' ? 'fa-times-circle' : 'fa-archive')"></i>
        {{ changingStateAssetId === assetToChangeState?.id ? 'Procesando...' : (estadoAction === 'baja' ? 'Dar de Baja' : 'Enviar a Almacén') }}
      </button>
    </div>
  </div>
</div>
