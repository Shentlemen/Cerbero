<div class="generic-container">
  <!-- Contenedor de notificaciones -->
  <app-notification-container></app-notification-container>
  
  <div class="header-section">
    <div class="title-wrapper">
      <div class="title-row">
        <h1><i class="fas fa-network-wired"></i> Dispositivos de Red</h1>
        
        <!-- Mensaje informativo para usuarios sin permisos -->
        <div *ngIf="!canUpdateDevices()" class="permission-info">
          <i class="fas fa-info-circle" style="color: #6c757d;"></i>
          <span style="color: #6c757d; font-size: 0.9rem; margin-left: 0.5rem;">
            Solo administradores pueden actualizar dispositivos de red
          </span>
        </div>
      </div>
      
      <!-- Filtros por tipo de dispositivo -->
      <div class="filters-container">
        <button 
          class="filter-btn" 
          [class.active]="isFilterActive('all')"
          (click)="applyFilter('all')">
          <i class="fas fa-th-large"></i>
          <span>Todos</span>
          <span class="count">({{getDeviceCount('all')}})</span>
        </button>
        
        <button 
          *ngFor="let deviceType of deviceTypes" 
          class="filter-btn" 
          [class.active]="isFilterActive(deviceType.name)"
          [style.--device-color]="deviceType.color"
          [style.--device-bg-color]="deviceType.backgroundColor"
          [style.--device-border-color]="deviceType.borderColor"
          (click)="applyFilter(deviceType.name)">
          <i class="fas" [ngClass]="deviceType.icon" [style.color]="deviceType.color"></i>
          <span>{{deviceType.name}}</span>
          <span class="count">({{getDeviceCount(deviceType.name)}})</span>
        </button>
      </div>
    </div>
  </div>

  <div class="content-section">
    <!-- Estado de carga -->
    <div *ngIf="loading" class="text-center p-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando dispositivos...</p>
    </div>

    <!-- Mensaje de error -->
    <div *ngIf="errorMessage" class="alert alert-danger m-3">
      <i class="fas fa-exclamation-circle me-2"></i>
      {{ errorMessage }}
    </div>

    <!-- Filtro de b√∫squeda por MAC -->
    <div class="search-container">
      <div class="search-input-group">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          class="form-control search-input" 
          placeholder="Buscar por MAC address..." 
          [formControl]="macSearchControl" 
          data-help="üîç Busca dispositivos espec√≠ficos por direcci√≥n MAC">
      </div>
      <button 
        *ngIf="macSearchControl.value" 
        class="btn btn-outline-secondary btn-sm clear-search-btn" 
        (click)="limpiarFiltros()"
        title="Limpiar filtros de b√∫squeda">
        <i class="fas fa-times"></i>
        Limpiar
      </button>
    </div>

    <!-- Tabla de dispositivos -->
    <div *ngIf="!loading && !errorMessage" class="table-container">
      <table class="generic-table">
        <thead>
          <tr>
            <th (click)="sortData('name')" [class.active]="sortColumn === 'name'" class="sortable-header">
              <div class="th-content">
                <span>Nombre de red</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'name' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'name' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'name'
                }"></i>
              </div>
            </th>
            <th (click)="sortData('ip')" [class.active]="sortColumn === 'ip'" class="sortable-header">
              <div class="th-content">
                <span>IP</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'ip' && sortDirection === 'asc',
                  'fa-sort-down': sortColumn === 'ip' && sortDirection === 'desc',
                  'fa-sort': sortColumn !== 'ip'
                }"></i>
              </div>
            </th>
            <th>
              <div class="th-content">
                <span>Tipo</span>
              </div>
            </th>
            <th (click)="sortData('description')" [class.active]="sortColumn === 'description'" class="sortable-header">
              <div class="th-content">
                <span>Descripci√≥n</span>
                <i class="fas" [ngClass]="{
                  'fa-sort-up': sortColumn === 'description' && sortDirection === 'desc',
                  'fa-sort-down': sortColumn === 'description' && sortDirection === 'asc',
                  'fa-sort': sortColumn !== 'description'
                }"></i>
              </div>
            </th>
            <th *ngIf="canManageDevices()">
              <div class="th-content">
                <span>Acciones</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let device of pagedDevices" class="device-row" (click)="verDetallesDevice(device)">
            <td>
              <div class="device-name">
                <i class="fas" 
                   [ngClass]="getDeviceIcon(device).icon"
                   [style.color]="getDeviceIcon(device).color"></i>
                <span>{{ device.name }}</span>
              </div>
            </td>
            <td>
              <span class="ip-address">{{ device.ip }}</span>
            </td>
            <td>
              <span class="type-badge" 
                    [style.background-color]="getDeviceTypeConfig(device.type).backgroundColor"
                    [style.color]="getDeviceTypeConfig(device.type).color"
                    [style.border-color]="getDeviceTypeConfig(device.type).borderColor">
                {{ device.type }}
              </span>
            </td>
            <td>
              <span class="description">{{ device.description }}</span>
            </td>
            <td *ngIf="canManageDevices()">
              <div class="action-buttons">
                <!-- Botones de cambio de estado solo si hay permisos -->
                <ng-container *ngIf="canManageDeviceStates()">
                  <button 
                    class="btn btn-warning btn-sm estado-btn baja-btn" 
                    (click)="darDeBaja(device); $event.stopPropagation()"
                    [disabled]="changingStateDeviceMac === device.mac"
                    title="Dar de baja este dispositivo (enviar al cementerio)"
                    data-help="‚ö∞Ô∏è Marca este dispositivo como dado de baja y lo env√≠a al cementerio">
                    <i class="fas" [ngClass]="changingStateDeviceMac === device.mac ? 'fa-spinner fa-spin' : 'fa-times-circle'"></i>
                    Baja
                  </button>
                  <button 
                    class="btn btn-info btn-sm estado-btn almacen-btn" 
                    (click)="enviarAAlmacen(device); $event.stopPropagation()"
                    [disabled]="changingStateDeviceMac === device.mac"
                    title="Enviar este dispositivo al almac√©n"
                    data-help="üì¶ Marca este dispositivo como almacenado">
                    <i class="fas" [ngClass]="changingStateDeviceMac === device.mac ? 'fa-spinner fa-spin' : 'fa-archive'"></i>
                    Almac√©n
                  </button>
                </ng-container>
                
                <!-- Mensaje informativo si no hay permisos para cambio de estado -->
                <small *ngIf="!canManageDeviceStates()" class="text-muted">
                  Requiere permisos de GM o Administrador
                </small>
                
                <!-- Bot√≥n de eliminar (siempre disponible si puede gestionar devices) -->
                <button 
                  class="btn btn-danger btn-sm delete-btn" 
                  (click)="eliminarDevice(device); $event.stopPropagation()"
                  [disabled]="deletingDeviceMac === device.mac"
                  title="Eliminar este dispositivo de la base de datos OCS"
                  data-help="Ô∏è Elimina permanentemente este dispositivo de la base de datos OCS">
                  <i class="fas" [ngClass]="deletingDeviceMac === device.mac ? 'fa-spinner fa-spin' : 'fa-trash'"></i>
                  {{ deletingDeviceMac === device.mac ? 'Eliminando...' : 'Eliminar' }}
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="pagedDevices.length === 0">
            <td colspan="4" class="text-center p-4">
              <div class="alert alert-info m-0">
                <i class="fas fa-info-circle me-2"></i>
                No hay dispositivos disponibles
                <span *ngIf="activeFilter !== 'all'"> del tipo seleccionado</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Paginaci√≥n -->
    <div *ngIf="!loading && !errorMessage && collectionSize > pageSize" class="pagination-container">
      <ngb-pagination
        [(page)]="page"
        [pageSize]="pageSize"
        [collectionSize]="collectionSize"
        [boundaryLinks]="true"
        [maxSize]="5"
        [rotate]="true"
        [ellipses]="false"
        class="custom-pagination">
      </ngb-pagination>
    </div>
  </div>
</div>

<!-- Di√°logo de confirmaci√≥n para eliminaci√≥n -->
<div *ngIf="showConfirmDialog" class="confirm-dialog-overlay">
  <div class="confirm-dialog">
    <div class="confirm-dialog-title">
      <i class="fas fa-exclamation-triangle"></i>
      Confirmar Eliminaci√≥n
    </div>
    <div class="confirm-dialog-message">
      ¬øEst√° seguro que desea eliminar este dispositivo? Esta acci√≥n no se puede deshacer.
    </div>
    <div class="confirm-dialog-buttons">
      <button class="confirm-dialog-button cancel" (click)="cancelarEliminacion()">
        Cancelar
      </button>
      <button class="confirm-dialog-button confirm" (click)="confirmarEliminacion()">
        Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Di√°logo de cambio de estado -->
<div *ngIf="showEstadoDialog" class="confirm-dialog-overlay">
  <div class="confirm-dialog estado-dialog">
    <div class="confirm-dialog-title">
      <i class="fas" [ngClass]="estadoAction === 'baja' ? 'fa-times-circle' : 'fa-archive'"></i>
      {{ estadoAction === 'baja' ? 'Dar de Baja' : 'Enviar a Almac√©n' }}
    </div>
    <div class="confirm-dialog-message">
      <p>¬øEst√° seguro que desea {{ getEstadoActionText() }} el dispositivo <strong>{{ deviceToChangeState?.name }}</strong>?</p>
      <div class="observaciones-container">
        <label for="observaciones">Observaciones (opcional):</label>
        <textarea 
          id="observaciones"
          [(ngModel)]="estadoObservaciones" 
          placeholder="Ingrese observaciones sobre el cambio de estado..."
          maxlength="500"
          rows="3"></textarea>
        <small class="text-muted">{{ estadoObservaciones.length }}/500 caracteres</small>
      </div>
    </div>
    <div class="confirm-dialog-buttons">
      <button class="confirm-dialog-button cancel" (click)="cancelarCambioEstado()">
        Cancelar
      </button>
      <button 
        class="confirm-dialog-button confirm" 
        [ngClass]="estadoAction === 'baja' ? 'baja' : 'almacen'"
        (click)="confirmarCambioEstado()"
        [disabled]="changingStateDeviceMac === deviceToChangeState?.mac">
        <i class="fas" [ngClass]="changingStateDeviceMac === deviceToChangeState?.mac ? 'fa-spinner fa-spin' : (estadoAction === 'baja' ? 'fa-times-circle' : 'fa-archive')"></i>
        {{ changingStateDeviceMac === deviceToChangeState?.mac ? 'Procesando...' : (estadoAction === 'baja' ? 'Dar de Baja' : 'Enviar a Almac√©n') }}
      </button>
    </div>
  </div>
</div> 