<div class="dashboard-container">
  <!-- Contenedor de notificaciones -->
  <app-notification-container></app-notification-container>
  
  <header class="dashboard-header">
    <h1 class="dashboard-title">
      <i class="fas fa-chart-line"></i>
      <span>Panel de Control</span>
    </h1>
  </header>
  <div class="charts-container">
    <div class="chart-card" *ngIf="pieChartOptions">
      <div class="chart-header">
        <h3>Terminales</h3>
        <button class="btn btn-sm btn-outline-primary expand-chart-btn" (click)="expandChart('terminales')" title="Ver gráfica en pantalla completa">
          <i class="fas fa-expand"></i>
        </button>
      </div>
      <canvasjs-chart [options]="pieChartOptions" [styles]="{width: '100%', height: '300px'}"></canvasjs-chart>
    </div>
    <div class="chart-card main-chart" *ngIf="barChartOptions">
      <div class="chart-header">
        <h3>Fabricante</h3>
        <button class="btn btn-sm btn-outline-primary expand-chart-btn" (click)="expandChart('fabricante')" title="Ver gráfica en pantalla completa">
          <i class="fas fa-expand"></i>
        </button>
      </div>
      <canvasjs-chart [options]="barChartOptions" [styles]="{width: '100%', height: '300px'}"></canvasjs-chart>
    </div>
    <div class="chart-card" *ngIf="pieChartOptions2">
      <div class="chart-header">
        <h3>Sistema Operativo</h3>
        <button class="btn btn-sm btn-outline-primary expand-chart-btn" (click)="expandChart('sistema-operativo')" title="Ver gráfica en pantalla completa">
          <i class="fas fa-expand"></i>
        </button>
      </div>
      <canvasjs-chart [options]="pieChartOptions2" [styles]="{width: '100%', height: '300px'}"></canvasjs-chart>
    </div>
    <div class="chart-card" *ngIf="lineChartOptions">
      <div class="chart-header">
        <h3>Dispositivos de Red</h3>
        <button class="btn btn-sm btn-outline-primary expand-chart-btn" (click)="expandChart('red')" title="Ver gráfica en pantalla completa">
          <i class="fas fa-expand"></i>
        </button>
      </div>
      <canvasjs-chart [options]="lineChartOptions" [styles]="{width: '100%', height: '300px'}"></canvasjs-chart>
    </div>
  </div>

  <div class="alerts-container">
    <div class="alerts-header">
      <h2 class="alerts-title">
        <i class="fa-solid fa-bell"></i>
        Alertas Recientes
      </h2>
      <div class="alerts-buttons">
        <button 
          class="btn btn-check-changes" 
          (click)="checkHardwareChanges()" 
          [disabled]="isChecking"
          title="Verificar cambios en el hardware">
          <i class="fas fa-sync-alt" [class.spinning]="isChecking"></i>
          {{ isChecking ? 'Verificando...' : 'Verificar cambios' }}
        </button>
        <button 
          class="btn btn-update-devices" 
          (click)="actualizarDispositivos()" 
          [disabled]="isUpdatingDevices"
          title="Actualizar dispositivos de red desde OCS"
          *ngIf="canUpdateDevices()">
          <i class="fas fa-network-wired" [class.spinning]="isUpdatingDevices"></i>
          {{ isUpdatingDevices ? 'Actualizando...' : 'Actualizar Dispositivos' }}
        </button>
        <button 
          class="btn btn-cleanup-alerts" 
          (click)="cleanupOrphanedAlerts()" 
          [disabled]="isCleaning"
          title="Verificar y limpiar todas las alertas obsoletas (hardware eliminado, software ya no prohibido, equipos 'nuevos' que ya existen, cambios que ya no son válidos)">
          <i class="fas fa-broom" [class.spinning]="isCleaning"></i>
          {{ isCleaning ? 'Limpiando...' : 'Limpiar alertas' }}
        </button>
      </div>
    </div>
    
    <!-- Filtros por tipo de alerta -->
    <div class="alert-filters">
      <div class="filter-buttons">
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'all'"
          (click)="filterAlerts('all')"
          title="Mostrar todas las alertas">
          <i class="fas fa-list"></i>
          <span>Todas</span>
          <span class="count">({{alerts.length}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'new_hardware'"
          [style.--device-color]="'#2e7d32'"
          [style.--device-bg-color]="'#e8f5e9'"
          [style.--device-border-color]="'#c8e6c9'"
          (click)="filterAlerts('new_hardware')"
          title="Mostrar solo alertas de equipos nuevos">
          <i class="fas fa-plus-circle" style="color: #2e7d32;"></i>
          <span>Nuevos</span>
          <span class="count">({{getFilterCount('new_hardware')}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'memory'"
          [style.--device-color]="'#1976d2'"
          [style.--device-bg-color]="'#e3f2fd'"
          [style.--device-border-color]="'#bbdefb'"
          (click)="filterAlerts('memory')"
          title="Mostrar solo alertas de cambios en memoria">
          <i class="fas fa-memory" style="color: #1976d2;"></i>
          <span>Memoria</span>
          <span class="count">({{getFilterCount('memory')}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'disk'"
          [style.--device-color]="'#f57c00'"
          [style.--device-bg-color]="'#fff3e0'"
          [style.--device-border-color]="'#ffe0b2'"
          (click)="filterAlerts('disk')"
          title="Mostrar solo alertas de uso de disco">
          <i class="fas fa-hdd" style="color: #f57c00;"></i>
          <span>Disco</span>
          <span class="count">({{getFilterCount('disk')}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'ip'"
          [style.--device-color]="'#388e3c'"
          [style.--device-bg-color]="'#e8f5e9'"
          [style.--device-border-color]="'#c8e6c9'"
          (click)="filterAlerts('ip')"
          title="Mostrar solo alertas de cambios de IP">
          <i class="fas fa-network-wired" style="color: #388e3c;"></i>
          <span>IP</span>
          <span class="count">({{getFilterCount('ip')}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'video'"
          [style.--device-color]="'#7b1fa2'"
          [style.--device-bg-color]="'#f3e5f5'"
          [style.--device-border-color]="'#e1bee7'"
          (click)="filterAlerts('video')"
          title="Mostrar solo alertas de cambios en video">
          <i class="fas fa-video" style="color: #7b1fa2;"></i>
          <span>Video</span>
          <span class="count">({{getFilterCount('video')}})</span>
        </button>
        <button 
          class="btn-filter" 
          [class.active]="currentFilter === 'software_forbidden'"
          [style.--device-color]="'#e74c3c'"
          [style.--device-bg-color]="'#fff5f5'"
          [style.--device-border-color]="'#fad2d2'"
          (click)="filterAlerts('software_forbidden')"
          title="Mostrar solo alertas de software prohibido">
          <i class="fas fa-ban" style="color: #e74c3c;"></i>
          <span>Software</span>
          <span class="count">({{getFilterCount('software_forbidden')}})</span>
        </button>
      </div>
    </div>
    
    <div class="alert-list">
      <div *ngIf="alerts.length === 0" class="no-alerts">
        <i class="fas fa-check-circle"></i>
        <h3>¡Todo en orden!</h3>
        <p>No hay alertas pendientes en este momento</p>
      </div>
      
      <div *ngFor="let alert of pagedAlerts" class="alert-item">
        <div class="alert-content">
          <div class="alert-header">
            <div class="alert-main-info">
              <span class="alert-title" 
                    [class.new-hardware-alert]="alert.new_hardware === 1"
                    (click)="alert.new_hardware === 1 ? showNewHardwareMessage() : navigateToAssetDetails(alert.hardwareId)"
                    [attr.data-bs-toggle]="alert.new_hardware === 1 ? 'tooltip' : null"
                    [attr.data-bs-title]="alert.new_hardware === 1 ? 'Este equipo aún no está registrado en la base de datos' : ''"
                    [ngStyle]="{'cursor': alert.new_hardware === 1 ? 'help' : 'pointer'}">
                {{alert.pcName}}
              </span>
              <div *ngIf="alert.memory" class="alert-tag-container memory">
                <span class="alert-tag-description">
                  <i class="fas fa-memory"></i> 
                  Cambio en la memoria RAM
                </span>
                <span class="alert-tag-value">
                  {{ alert.valorAnterior }} → {{ alert.valorNuevo }}
                </span>
              </div>
              <div *ngIf="alert.disk" class="alert-tag-container disk">
                <span class="alert-tag-description">
                  <i class="fas fa-hdd"></i> 
                  Uso de disco detectado
                </span>
                <span class="alert-tag-value">
                  {{ alert.valorNuevo }}%
                </span>
              </div>
              <div *ngIf="alert.ip" class="alert-tag-container ip">
                <span class="alert-tag-description">
                  <i class="fas fa-network-wired"></i> 
                  Cambio de dirección IP
                </span>
                <span class="alert-tag-value">
                  {{ alert.valorAnterior }} → {{ alert.valorNuevo }}
                </span>
              </div>
              <div *ngIf="alert.video" class="alert-tag-container video">
                <span class="alert-tag-description">
                  <i class="fas fa-video"></i> 
                  Cambio en tarjeta de video
                </span>
                <span class="alert-tag-value">
                  {{ alert.valorAnterior }} → {{ alert.valorNuevo }}
                </span>
              </div>
              <div *ngIf="alert.new_hardware === 1" class="alert-tag-container new-hardware">
                <span class="alert-tag-description">
                  <i class="fas fa-plus-circle"></i> 
                  Nuevo equipo detectado
                </span>
                <span class="alert-tag-value">
                  en la red
                </span>
              </div>
              <div *ngIf="alert.softwareForbidden" class="alert-tag-container software-forbidden">
                <span class="alert-tag-description">
                  <i class="fas fa-ban"></i> 
                  Software prohibido detectado
                </span>
                <span class="alert-tag-value">
                  {{ alert.valorNuevo }}
                </span>
              </div>
            </div>
            <span class="alert-date">{{alert.fecha | date:'dd/MM/yyyy HH:mm'}}</span>
          </div>
        </div>
        <button 
          class="btn btn-sm btn-primary" 
          (click)="confirmarAlerta(alert)"
          [disabled]="alert.confirmada"
          *ngIf="!alert.softwareForbidden && canConfirmAlerts()">
          {{alert.confirmada ? 'Confirmada' : 'Confirmar'}}
        </button>
      </div>
    </div>
    <div class="pagination-container">
      <ngb-pagination
        [(page)]="page"
        [pageSize]="pageSize"
        [collectionSize]="collectionSize"
        [boundaryLinks]="true"
        [maxSize]="5"
        [rotate]="true"
        [ellipses]="false"
        class="custom-pagination">
      </ngb-pagination>
    </div>
  </div>
</div>

<!-- Modal para gráfica expandida usando NgbModal -->
<ng-template #chartModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">{{ expandedChartTitle }}</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal(modal)"></button>
  </div>
  <div class="modal-body">
    <div class="expanded-chart-container">
      <canvasjs-chart 
        [options]="expandedChartOptions" 
        [styles]="{width: '100%', height: '100%'}">
      </canvasjs-chart>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal(modal)">Cerrar</button>
  </div>
</ng-template>
